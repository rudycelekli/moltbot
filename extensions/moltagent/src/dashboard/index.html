<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MoltAgent Dashboard</title>
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --surface2: #1a1a25;
      --border: #2a2a3a;
      --text: #e0e0e8;
      --text-dim: #888898;
      --accent: #6366f1;
      --accent-dim: #4f46e5;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #eab308;
      --orange: #f97316;
      --font: 'SF Mono', 'Cascadia Code', 'Fira Code', monospace;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
      line-height: 1.5;
    }

    /* Layout */
    .app { display: flex; height: 100vh; }
    .sidebar {
      width: 220px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      font-size: 15px;
      color: var(--accent);
    }
    .sidebar-nav { padding: 8px; flex: 1; }
    .nav-item {
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-dim);
      transition: all 0.15s;
    }
    .nav-item:hover { background: var(--surface2); color: var(--text); }
    .nav-item.active { background: var(--accent-dim); color: white; }
    .nav-badge {
      margin-left: auto;
      background: var(--red);
      color: white;
      padding: 1px 6px;
      border-radius: 10px;
      font-size: 11px;
    }

    .main { flex: 1; overflow-y: auto; padding: 24px; }

    /* Cards */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }
    .stat-label { color: var(--text-dim); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 28px; font-weight: 700; margin-top: 4px; }
    .stat-value.green { color: var(--green); }
    .stat-value.yellow { color: var(--yellow); }
    .stat-value.red { color: var(--red); }

    /* Agent List */
    .section-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .agent-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .agent-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .agent-card:hover { border-color: var(--accent); }
    .agent-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .agent-status {
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .agent-status.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .agent-status.offline { background: var(--text-dim); }
    .agent-name { font-weight: 600; font-size: 14px; }
    .agent-meta { display: flex; gap: 16px; color: var(--text-dim); font-size: 11px; }
    .agent-tags { display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap; }
    .tag {
      background: var(--surface2);
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      color: var(--text-dim);
    }

    /* Actions feed */
    .action-feed {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
    }
    .action-item {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 12px;
      align-items: flex-start;
      font-size: 12px;
    }
    .action-item:last-child { border-bottom: none; }
    .action-time { color: var(--text-dim); white-space: nowrap; min-width: 70px; }
    .action-agent { color: var(--accent); min-width: 80px; }
    .action-cat {
      padding: 1px 6px;
      border-radius: 3px;
      font-size: 10px;
      text-transform: uppercase;
      min-width: 60px;
      text-align: center;
    }
    .action-cat.browse { background: #1e3a5f; color: #60a5fa; }
    .action-cat.execute { background: #3b1f2b; color: #f472b6; }
    .action-cat.message { background: #1a3329; color: #4ade80; }
    .action-cat.spend { background: #3b2f1a; color: #fbbf24; }
    .action-cat.api_call { background: #2d1b4e; color: #a78bfa; }
    .action-cat.file { background: #1b2d3e; color: #67e8f9; }
    .action-summary { flex: 1; }

    /* Approvals */
    .approval-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
    .approval-card {
      background: var(--surface);
      border: 1px solid var(--yellow);
      border-radius: 8px;
      padding: 16px;
    }
    .approval-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .approval-agent { color: var(--accent); font-weight: 600; }
    .approval-amount { color: var(--yellow); font-weight: 700; font-size: 18px; }
    .approval-desc { color: var(--text-dim); margin-bottom: 12px; }
    .approval-actions { display: flex; gap: 8px; }
    .btn {
      padding: 6px 16px;
      border-radius: 6px;
      border: none;
      font-family: var(--font);
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.15s;
    }
    .btn-approve { background: var(--green); color: white; }
    .btn-approve:hover { opacity: 0.85; }
    .btn-deny { background: var(--red); color: white; }
    .btn-deny:hover { opacity: 0.85; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-dim); }

    /* Deploy form */
    .deploy-form {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      max-width: 600px;
    }
    .form-group { margin-bottom: 16px; }
    .form-label {
      display: block;
      color: var(--text-dim);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 8px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: var(--font);
      font-size: 13px;
    }
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .form-textarea { min-height: 100px; resize: vertical; }
    .form-row { display: flex; gap: 12px; }
    .form-row > .form-group { flex: 1; }

    .checkbox-group { display: flex; gap: 16px; flex-wrap: wrap; }
    .checkbox-label {
      display: flex; align-items: center; gap: 6px;
      color: var(--text-dim); cursor: pointer;
    }
    .checkbox-label input { accent-color: var(--accent); }

    .empty-state {
      text-align: center;
      padding: 48px;
      color: var(--text-dim);
    }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 48px;
      color: var(--text-dim);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div class="sidebar-header">MoltAgent</div>
      <div class="sidebar-nav">
        <div class="nav-item active" data-view="overview">Overview</div>
        <div class="nav-item" data-view="agents">Agents</div>
        <div class="nav-item" data-view="actions">Action Feed</div>
        <div class="nav-item" data-view="approvals">
          Approvals
          <span class="nav-badge" id="approval-count" style="display:none">0</span>
        </div>
        <div class="nav-item" data-view="deploy">Deploy New</div>
      </div>
    </div>
    <div class="main" id="main-content">
      <div class="loading">Loading...</div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin + '/moltagent/dashboard';
    const TOKEN = localStorage.getItem('moltagent_token') || prompt('Enter your MoltAgent API token:');
    if (TOKEN) localStorage.setItem('moltagent_token', TOKEN);

    async function api(path, opts = {}) {
      const res = await fetch(API_BASE + path, {
        ...opts,
        headers: {
          'Authorization': `Bearer ${TOKEN}`,
          'Content-Type': 'application/json',
          ...(opts.headers || {}),
        },
        body: opts.body ? JSON.stringify(opts.body) : undefined,
      });
      return res.json();
    }

    let currentView = 'overview';
    let refreshInterval = null;

    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelector('.nav-item.active')?.classList.remove('active');
        item.classList.add('active');
        currentView = item.dataset.view;
        renderView();
      });
    });

    async function renderView() {
      clearInterval(refreshInterval);
      const main = document.getElementById('main-content');

      switch (currentView) {
        case 'overview': await renderOverview(main); break;
        case 'agents': await renderAgents(main); break;
        case 'actions': await renderActions(main); break;
        case 'approvals': await renderApprovals(main); break;
        case 'deploy': renderDeploy(main); break;
      }

      // Auto-refresh every 5s for live views
      if (['overview', 'agents', 'actions', 'approvals'].includes(currentView)) {
        refreshInterval = setInterval(() => renderView(), 5000);
      }
    }

    async function renderOverview(el) {
      const data = await api('/overview');
      const f = data.fleet || {};
      const a = data.approvals || {};
      el.innerHTML = `
        <div class="section-title">Fleet Overview</div>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-label">Total Agents</div>
            <div class="stat-value">${f.total || 0}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Online</div>
            <div class="stat-value green">${f.online || 0}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Offline</div>
            <div class="stat-value ${f.offline ? 'red' : ''}">${f.offline || 0}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Actions</div>
            <div class="stat-value">${(f.totalActions || 0).toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Spend</div>
            <div class="stat-value yellow">$${(f.totalSpend || 0).toFixed(2)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pending Approvals</div>
            <div class="stat-value ${a.pending ? 'orange' : ''}">${a.pending || 0}</div>
          </div>
        </div>
        <div class="section-title">Online Agents</div>
        <div id="online-agents"></div>
      `;
      // Fetch and render online agents
      const agentData = await api('/agents');
      const online = (agentData.agents || []).filter(a => a.connection === 'online');
      const container = document.getElementById('online-agents');
      if (online.length === 0) {
        container.innerHTML = '<div class="empty-state">No agents online</div>';
      } else {
        container.innerHTML = '<div class="agent-grid">' + online.map(agentCard).join('') + '</div>';
      }
      updateApprovalBadge(a.pending || 0);
    }

    async function renderAgents(el) {
      const data = await api('/agents');
      const agents = data.agents || [];
      if (agents.length === 0) {
        el.innerHTML = `
          <div class="section-title">All Agents</div>
          <div class="empty-state">
            <div class="empty-state-icon">+</div>
            <div>No agents deployed yet</div>
            <br/>
            <button class="btn btn-primary" onclick="document.querySelector('[data-view=deploy]').click()">Deploy Your First Agent</button>
          </div>
        `;
        return;
      }
      el.innerHTML = `
        <div class="section-title">All Agents (${agents.length})</div>
        <div class="agent-grid">${agents.map(agentCard).join('')}</div>
      `;
    }

    function agentCard(a) {
      const caps = [];
      if (a.capabilities?.webBrowsing) caps.push('web');
      if (a.capabilities?.codeExecution) caps.push('code');
      if (a.capabilities?.terminalAccess) caps.push('terminal');
      return `
        <div class="agent-card" onclick="viewAgent('${a.id}')">
          <div class="agent-header">
            <div class="agent-status ${a.connection}"></div>
            <div class="agent-name">${esc(a.name)}</div>
          </div>
          <div class="agent-meta">
            <span>${a.connection}</span>
            <span>${a.totalActions} actions</span>
            <span>$${(a.totalSpend || 0).toFixed(2)} spent</span>
            ${a.channelCount ? `<span>${a.channelCount} channels</span>` : ''}
          </div>
          ${a.activeTask ? `<div style="color:var(--yellow);margin-top:8px;font-size:11px">Working: ${esc(a.activeTask)}</div>` : ''}
          <div class="agent-tags">
            ${caps.map(c => `<span class="tag">${c}</span>`).join('')}
            ${(a.tags || []).map(t => `<span class="tag">${esc(t)}</span>`).join('')}
          </div>
        </div>
      `;
    }

    async function viewAgent(id) {
      clearInterval(refreshInterval);
      const main = document.getElementById('main-content');
      const data = await api(`/agents/${id}`);
      if (data.error) { main.innerHTML = `<div class="empty-state">${data.error}</div>`; return; }
      const r = data;
      const m = r.manifest || {};
      main.innerHTML = `
        <div class="section-title">
          <span class="agent-status ${r.connection}" style="width:10px;height:10px"></span>
          ${esc(m.identity?.name || id)}
          <button class="btn btn-primary" onclick="sendMessage('${id}')" style="margin-left:auto">Send Message</button>
          <button class="btn btn-deny" onclick="destroyAgent('${id}')">Destroy</button>
        </div>
        <div class="stats">
          <div class="stat-card"><div class="stat-label">Status</div><div class="stat-value">${r.lastStatus?.state || r.connection}</div></div>
          <div class="stat-card"><div class="stat-label">Uptime</div><div class="stat-value">${formatUptime(r.uptimeSec)}</div></div>
          <div class="stat-card"><div class="stat-label">Actions</div><div class="stat-value">${r.totalActions}</div></div>
          <div class="stat-card"><div class="stat-label">Spend</div><div class="stat-value yellow">$${(r.totalSpend||0).toFixed(2)}</div></div>
          <div class="stat-card"><div class="stat-label">Pending Approvals</div><div class="stat-value ${r.pendingApprovals?'orange':''}">${r.pendingApprovals||0}</div></div>
        </div>
        <div class="section-title">Goals</div>
        ${(m.goals?.goals||[]).length === 0 ? '<div style="color:var(--text-dim)">No goals set</div>' :
          (m.goals.goals||[]).map(g => `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px">
            <div style="font-weight:600">[P${g.priority}] ${esc(g.title)}</div>
            ${g.description ? `<div style="color:var(--text-dim);font-size:12px;margin-top:4px">${esc(g.description)}</div>` : ''}
            ${(g.keyResults||[]).map(kr => `<div style="font-size:11px;color:var(--text-dim);margin-top:2px">- ${esc(kr.description)} ${kr.targetValue ? `(${kr.currentValue}/${kr.targetValue} ${kr.unit})` : ''}</div>`).join('')}
          </div>`).join('')}
        <div class="section-title" style="margin-top:24px">Recent Actions</div>
        <div id="agent-actions"></div>
      `;
      const actions = await api(`/agents/${id}/actions?limit=30`);
      document.getElementById('agent-actions').innerHTML = renderActionFeed(actions.actions || []);
      refreshInterval = setInterval(async () => {
        const a2 = await api(`/agents/${id}/actions?limit=30`);
        const el2 = document.getElementById('agent-actions');
        if (el2) el2.innerHTML = renderActionFeed(a2.actions || []);
      }, 5000);
    }

    async function renderActions(el) {
      const agentData = await api('/agents');
      const allActions = [];
      for (const a of (agentData.agents || []).slice(0, 20)) {
        const actions = await api(`/agents/${a.id}/actions?limit=20`);
        for (const act of (actions.actions || [])) {
          allActions.push({ ...act, _agentName: a.name, _agentId: a.id });
        }
      }
      allActions.sort((a, b) => (b.timestamp || '').localeCompare(a.timestamp || ''));
      el.innerHTML = `
        <div class="section-title">Live Action Feed</div>
        ${allActions.length === 0 ?
          '<div class="empty-state">No actions recorded yet</div>' :
          renderActionFeed(allActions.slice(0, 100))}
      `;
    }

    function renderActionFeed(actions) {
      if (actions.length === 0) return '<div class="empty-state">No actions</div>';
      return `<div class="action-feed">${actions.map(a => `
        <div class="action-item">
          <span class="action-time">${formatTime(a.timestamp)}</span>
          ${a._agentName ? `<span class="action-agent">${esc(a._agentName)}</span>` : ''}
          <span class="action-cat ${a.category}">${a.category}</span>
          <span class="action-summary">${esc(a.summary)}</span>
          ${a.durationMs ? `<span style="color:var(--text-dim)">${a.durationMs}ms</span>` : ''}
        </div>`).join('')}</div>`;
    }

    async function renderApprovals(el) {
      const pending = await api('/approvals');
      const history = await api('/approvals/history?limit=20');
      const items = pending.approvals || [];
      updateApprovalBadge(items.length);
      el.innerHTML = `
        <div class="section-title">Pending Approvals (${items.length})</div>
        ${items.length === 0 ? '<div class="empty-state">No pending approvals</div>' :
          `<div class="approval-list">${items.map(a => `
            <div class="approval-card">
              <div class="approval-header">
                <span class="approval-agent">${esc(a.agentId.slice(0,8))}</span>
                ${a.amount != null ? `<span class="approval-amount">$${a.amount.toFixed(2)} ${a.currency||'USD'}</span>` : ''}
              </div>
              <div class="approval-desc">${esc(a.description)}</div>
              <div style="color:var(--text-dim);font-size:11px;margin-bottom:8px">
                Expires: ${formatTime(a.expiresAt)} | Category: ${a.category}
              </div>
              <div class="approval-actions">
                <button class="btn btn-approve" onclick="respondApproval('${a.id}', true)">Approve</button>
                <button class="btn btn-deny" onclick="respondApproval('${a.id}', false)">Deny</button>
              </div>
            </div>`).join('')}</div>`}
        <div class="section-title" style="margin-top:24px">History</div>
        ${(history.history||[]).length === 0 ? '<div style="color:var(--text-dim)">No history</div>' :
          `<div class="action-feed">${(history.history||[]).map(h => `
            <div class="action-item">
              <span class="action-time">${formatTime(h.respondedAt || h.createdAt)}</span>
              <span class="action-agent">${esc(h.agentId.slice(0,8))}</span>
              <span class="action-cat ${h.state === 'approved' ? 'message' : h.state === 'denied' ? 'execute' : 'browse'}">${h.state}</span>
              <span class="action-summary">${esc(h.description)}${h.amount != null ? ` ($${h.amount.toFixed(2)})` : ''}</span>
            </div>`).join('')}</div>`}
      `;
    }

    function renderDeploy(el) {
      el.innerHTML = `
        <div class="section-title">Deploy New MoltAgent</div>
        <div class="deploy-form">
          <div class="form-group">
            <label class="form-label">Agent Name</label>
            <input class="form-input" id="d-name" placeholder="e.g. Research Assistant" />
          </div>
          <div class="form-group">
            <label class="form-label">Description</label>
            <input class="form-input" id="d-desc" placeholder="What does this agent do?" />
          </div>
          <div class="form-group">
            <label class="form-label">System Prompt</label>
            <textarea class="form-textarea" id="d-prompt" placeholder="You are a..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Provider</label>
              <select class="form-select" id="d-provider">
                <option value="anthropic">Anthropic (Claude)</option>
                <option value="openai">OpenAI</option>
                <option value="google">Google</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Model</label>
              <input class="form-input" id="d-model" value="claude-sonnet-4-20250514" />
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Capabilities</label>
            <div class="checkbox-group">
              <label class="checkbox-label"><input type="checkbox" id="d-web" checked /> Web Browsing</label>
              <label class="checkbox-label"><input type="checkbox" id="d-code" /> Code Execution</label>
              <label class="checkbox-label"><input type="checkbox" id="d-terminal" /> Terminal Access</label>
              <label class="checkbox-label"><input type="checkbox" id="d-fs" /> File System</label>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Server Type</label>
              <select class="form-select" id="d-server">
                <option value="cpx21">cpx21 (2 vCPU, 4GB)</option>
                <option value="cpx31">cpx31 (4 vCPU, 8GB)</option>
                <option value="cpx41">cpx41 (8 vCPU, 16GB)</option>
                <option value="docker-local">Docker Local (dev)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Region</label>
              <select class="form-select" id="d-region">
                <option value="nbg1">Nuremberg (EU)</option>
                <option value="fsn1">Falkenstein (EU)</option>
                <option value="hel1">Helsinki (EU)</option>
                <option value="ash">Ashburn (US)</option>
                <option value="hil">Hillsboro (US)</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Max Daily Spend ($)</label>
              <input class="form-input" id="d-spend" type="number" value="10" />
            </div>
            <div class="form-group">
              <label class="form-label">Skills (comma-separated)</label>
              <input class="form-input" id="d-skills" placeholder="github, coding-agent" />
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Tags (comma-separated)</label>
            <input class="form-input" id="d-tags" placeholder="dev, research" />
          </div>
          <br/>
          <button class="btn btn-primary" onclick="deployAgent()" style="width:100%;padding:10px">Deploy Agent</button>
        </div>
      `;
    }

    // Actions
    async function deployAgent() {
      const manifest = {
        schemaVersion: '1.0',
        identity: {
          id: crypto.randomUUID(),
          name: document.getElementById('d-name').value || 'Unnamed Agent',
          ownerId: 'dashboard-user',
          description: document.getElementById('d-desc').value,
          tags: (document.getElementById('d-tags').value || '').split(',').map(s => s.trim()).filter(Boolean),
        },
        agentConfig: {
          systemPrompt: document.getElementById('d-prompt').value || 'You are a helpful assistant.',
          provider: document.getElementById('d-provider').value,
          model: document.getElementById('d-model').value,
          skills: (document.getElementById('d-skills').value || '').split(',').map(s => s.trim()).filter(Boolean),
        },
        capabilities: {
          webBrowsing: document.getElementById('d-web').checked,
          codeExecution: document.getElementById('d-code').checked,
          terminalAccess: document.getElementById('d-terminal').checked,
          fileSystem: document.getElementById('d-fs').checked,
        },
        channels: { channels: [] },
        resources: {
          serverType: document.getElementById('d-server').value,
          region: document.getElementById('d-region').value,
        },
        financialControls: {
          maxPerDay: Number(document.getElementById('d-spend').value) || 10,
          requireApprovalForAllSpend: true,
        },
        controlPlane: {
          url: window.location.origin.replace('http', 'ws') + '/moltagent/ws',
          token: TOKEN,
        },
        retention: { liveActionStream: true },
        goals: { goals: [] },
        knowledge: {},
      };
      const res = await api('/agents', { method: 'POST', body: manifest });
      if (res.agentId) {
        alert('Agent deployed: ' + res.agentId.slice(0, 8));
        document.querySelector('[data-view=agents]').click();
      } else {
        alert('Deploy failed: ' + (res.error || JSON.stringify(res)));
      }
    }

    async function sendMessage(agentId) {
      const content = prompt('Message to send to agent:');
      if (!content) return;
      await api(`/agents/${agentId}/message`, { method: 'POST', body: { content } });
    }

    async function destroyAgent(agentId) {
      if (!confirm('Destroy this agent? This will terminate the VPS.')) return;
      await api(`/agents/${agentId}`, { method: 'DELETE' });
      document.querySelector('[data-view=agents]').click();
    }

    async function respondApproval(requestId, approved) {
      await api(`/approvals/${requestId}/respond`, {
        method: 'POST',
        body: { approved, respondedBy: 'dashboard' },
      });
      renderView();
    }

    // Helpers
    function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
    function formatTime(ts) {
      if (!ts) return '--';
      const d = new Date(ts);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    function formatUptime(sec) {
      if (!sec) return '--';
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      return h > 0 ? `${h}h ${m}m` : `${m}m`;
    }
    function updateApprovalBadge(count) {
      const badge = document.getElementById('approval-count');
      if (count > 0) { badge.textContent = count; badge.style.display = ''; }
      else { badge.style.display = 'none'; }
    }

    // Boot
    renderView();
  </script>
</body>
</html>
